<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiFractal | Mobile Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&family=Inter:wght@400;500&display=swap');

        :root {
            --bg: #050508;
            --card-bg: #121217;
            --border: #27272a;
            --accent: #3b82f6;
            --text: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            width: 100vw;
            height: 100vh;
            overflow: hidden; /* Desktop default */
        }

        /* --- DESKTOP VIEWPORT --- */
        #viewport {
            width: 100%;
            height: 100%;
            overflow: hidden;
            cursor: grab;
            position: relative;
            touch-action: none; /* Prevents browser handling on desktop to allow custom drag */
        }
        #viewport.panning { cursor: grabbing; }

        #world {
            position: absolute;
            display: flex;
            padding: 50vh 50vw;
            transform-origin: 0 0;
            will-change: transform;
        }

        /* --- TREE LAYOUT --- */
        .node-wrapper {
            display: flex;
            align-items: center;
            gap: 80px;
            position: relative;
        }

        .children-stack {
            display: flex;
            flex-direction: column;
            gap: 40px;
            position: relative;
        }

        /* Desktop Connectors */
        .desktop-only-connector::before {
            content: ''; position: absolute;
            left: -80px; top: 50%; width: 80px; height: 2px;
            background: #3f3f46;
        }
        .desktop-only-connector::after {
            content: ''; position: absolute;
            left: -80px; top: 0; bottom: 0; width: 2px;
            background: #3f3f46;
        }
        .children-stack > .node-wrapper:only-child::after { display: none; }
        .children-stack > .node-wrapper:first-child::after { top: 50%; }
        .children-stack > .node-wrapper:last-child::after { bottom: 50%; }

        /* --- CARD UI --- */
        .card {
            width: 450px;
            height: 600px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.4);
            transition: border-color 0.2s;
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; border-bottom: 1px solid var(--border);
            background: rgba(255,255,255,0.02);
        }

        .card-title {
            font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: #fff;
            max-width: 350px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .card-body {
            flex: 1; overflow-y: auto; padding: 20px;
            font-size: 0.95rem; line-height: 1.6; color: #d1d5db;
        }

        /* Wiki Content Styling */
        .wiki-text h2 { color: #fff; margin: 1.5rem 0 0.5rem; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .wiki-text p { margin-bottom: 1rem; }
        .wiki-text a { color: var(--accent); text-decoration: none; }
        .wiki-text ul { padding-left: 20px; margin-bottom: 1rem; }
        
        /* --- UI ELEMENTS --- */
        .search-bar {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; width: 400px; 
            background: rgba(18,18,23,0.9); backdrop-filter: blur(8px);
            border: 1px solid var(--border); border-radius: 12px;
            padding: 12px 16px; display: flex; align-items: center; gap: 10px;
        }
        .search-input { background: transparent; border: none; outline: none; color: white; width: 100%; font-size: 1rem; }
        
        .suggestions {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            width: 400px; background: #18181b; border: 1px solid var(--border);
            border-radius: 12px; overflow: hidden; display: none; z-index: 99;
        }
        .suggestions.active { display: block; }
        .s-item { padding: 12px 16px; border-bottom: 1px solid #27272a; cursor: pointer; color: #a1a1aa; }
        .s-item:hover { background: #27272a; color: white; }

        .controls { 
            position: fixed; bottom: 30px; right: 30px; 
            display: flex; flex-direction: column; gap: 10px; z-index: 90; 
        }
        .btn { 
            width: 44px; height: 44px; background: #18181b; border: 1px solid var(--border); 
            border-radius: 8px; color: #a1a1aa; cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }
        .btn:hover { border-color: var(--accent); color: white; }

        /* --- MOBILE OVERRIDES (THE FIX) --- */
        @media (max-width: 768px) {
            body {
                overflow-y: auto; /* Enable native vertical scroll */
                height: auto;
                background: var(--bg);
            }

            #viewport {
                position: static; /* Remove relative positioning constraints */
                height: auto;
                overflow: visible;
                cursor: default;
                touch-action: auto; /* Re-enable native touch */
            }

            #world {
                position: relative; /* Static flow */
                transform: none !important; /* Force disable GSAP transforms */
                display: block;
                padding: 100px 16px 40px 16px; /* Top padding for search bar */
                width: 100%;
            }

            /* Stack cards vertically */
            .node-wrapper {
                flex-direction: column;
                gap: 20px;
                margin-bottom: 20px;
                width: 100%;
            }

            /* Indent children to show hierarchy */
            .children-stack {
                width: 100%;
                padding-left: 10px;
                margin-left: 6px;
                border-left: 2px solid #333; /* Simple vertical line for hierarchy */
                gap: 20px;
            }
            
            /* Hide desktop connectors */
            .desktop-only-connector::before, 
            .desktop-only-connector::after { display: none; }

            /* Mobile Card Styling */
            .card {
                width: 100%;
                height: auto; /* Let content dictate height */
                max-height: 500px; /* Cap it so it doesn't take forever to scroll */
                border-radius: 12px;
            }

            /* UI Adjustments */
            .search-bar { width: 92%; top: 10px; }
            .suggestions { width: 92%; top: 70px; }
            .controls { display: none; /* Hide zoom controls on mobile */ }
        }

        .spinner { border: 2px solid #333; border-top-color: var(--accent); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="search-bar">
        <i class="ri-search-line text-gray-500"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search Topic..." autocomplete="off">
        <div id="loader" class="spinner" style="opacity: 0;"></div>
    </div>
    <div id="suggestions" class="suggestions"></div>

    <div class="controls">
        <button class="btn" onclick="zoomIn()"><i class="ri-add-line"></i></button>
        <button class="btn" onclick="zoomOut()"><i class="ri-subtract-line"></i></button>
        <button class="btn" onclick="resetView()"><i class="ri-focus-2-line"></i></button>
    </div>

    <div id="viewport">
        <div id="world"></div>
    </div>

    <script>
        // --- State ---
        const state = {
            scale: 1,
            x: 0, y: 0,
            isDragging: false,
            startX: 0, startY: 0,
            isMobile: window.innerWidth <= 768
        };

        const dom = {
            viewport: document.getElementById('viewport'),
            world: document.getElementById('world'),
            input: document.getElementById('searchInput'),
            suggestions: document.getElementById('suggestions'),
            loader: document.getElementById('loader')
        };

        // --- Layout Engine ---
        function checkDevice() {
            state.isMobile = window.innerWidth <= 768;
            if(state.isMobile) {
                // Kill transforms for mobile to allow native flow
                dom.world.style.transform = 'none';
            } else {
                updateTransform();
            }
        }
        window.addEventListener('resize', checkDevice);

        function updateTransform() {
            if(state.isMobile) return; // STRICTLY FORBID TRANSFORMS ON MOBILE
            dom.world.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
        }

        // --- Desktop Interactions Only ---
        dom.viewport.addEventListener('mousedown', (e) => {
            if(state.isMobile) return; // Stop logic if mobile
            if (e.target.closest('.card-body') || e.target.closest('.search-bar') || e.target.closest('.btn')) return;
            state.isDragging = true;
            state.startX = e.clientX - state.x;
            state.startY = e.clientY - state.y;
            dom.viewport.classList.add('panning');
        });

        window.addEventListener('mouseup', () => {
            state.isDragging = false;
            dom.viewport.classList.remove('panning');
        });

        window.addEventListener('mousemove', (e) => {
            if (!state.isDragging || state.isMobile) return;
            e.preventDefault();
            state.x = e.clientX - state.startX;
            state.y = e.clientY - state.startY;
            updateTransform();
        });

        dom.viewport.addEventListener('wheel', (e) => {
            if(state.isMobile) return; // Allow native scroll on mobile
            if (e.target.closest('.card-body')) return; // Allow internal card scroll

            e.preventDefault();
            const s = Math.exp(e.deltaY * -0.001);
            state.scale = Math.min(Math.max(0.1, state.scale * s), 4);
            updateTransform();
        }, { passive: false });


        // --- Wikipedia Logic ---
        const API = 'https://en.wikipedia.org/w/api.php?origin=*';

        async function fetchSuggestions(query) {
            if (query.length < 2) return [];
            const res = await fetch(`${API}&action=opensearch&search=${query}&limit=5&format=json`);
            const data = await res.json();
            return data[1];
        }

        async function fetchPage(title) {
            try {
                const res = await fetch(`${API}&action=parse&page=${title}&format=json&prop=text|displaytitle&redirects=1&disableeditsection=1`);
                const data = await res.json();
                if(data.error) throw new Error("Not found");
                return { title: data.parse.displaytitle, html: data.parse.text['*'] };
            } catch (e) {
                return null;
            }
        }

        function createNode(title, parentStack = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'node-wrapper';

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${title}</div>
                    <i class="ri-close-line" style="cursor:pointer; opacity:0.6;" onclick="removeNode(this)"></i>
                </div>
                <div class="card-body">
                    <div style="display:flex; justify-content:center; padding:20px; color:#555;">
                        <div class="spinner"></div>
                    </div>
                </div>
            `;

            wrapper.appendChild(card);

            if (!parentStack) {
                dom.world.innerHTML = '';
                dom.world.appendChild(wrapper);
                if(!state.isMobile) centerView();
            } else {
                parentStack.appendChild(wrapper);
                // MOBILE UX FIX: Scroll to the new card
                if(state.isMobile) {
                    setTimeout(() => {
                        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }

            // Animate entry
            gsap.from(card, { opacity:0, y:20, duration:0.4 });

            fetchPage(title).then(data => {
                const body = card.querySelector('.card-body');
                if(!data) {
                    body.innerHTML = '<div style="color:red; text-align:center;">Failed to load</div>';
                    return;
                }
                
                // Sanitize and Insert
                const clean = DOMPurify.sanitize(data.html, {
                    FORBID_TAGS: ['style','script','img','table'] // Aggressive strip for clean UI
                });
                
                card.querySelector('.card-title').innerHTML = data.title;
                body.innerHTML = `<div class="wiki-text">${clean}</div>`;

                // Intercept Links
                body.querySelectorAll('a').forEach(link => {
                    const href = link.getAttribute('href');
                    if(href && href.startsWith('/wiki/')) {
                        const target = href.replace('/wiki/', '');
                        link.onclick = (e) => {
                            e.preventDefault();
                            spawnChild(wrapper, target);
                        };
                    } else {
                        // Disable external links or open new tab
                        link.target = "_blank";
                    }
                });
            });
        }

        function spawnChild(parentWrapper, title) {
            let stack = parentWrapper.querySelector('.children-stack');
            if(!stack) {
                stack = document.createElement('div');
                stack.className = 'children-stack desktop-only-connector';
                parentWrapper.appendChild(stack);
            }
            createNode(title, stack);
        }

        function removeNode(icon) {
            const wrapper = icon.closest('.node-wrapper');
            wrapper.remove();
        }

        // --- Controls ---
        let debounce;
        dom.input.addEventListener('input', (e) => {
            const val = e.target.value;
            if(val.length < 2) { dom.suggestions.classList.remove('active'); return; }
            
            clearTimeout(debounce);
            dom.loader.style.opacity = 1;
            
            debounce = setTimeout(async () => {
                const results = await fetchSuggestions(val);
                dom.loader.style.opacity = 0;
                dom.suggestions.innerHTML = '';
                
                results.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 's-item';
                    div.innerText = r;
                    div.onclick = () => {
                        createNode(r);
                        dom.suggestions.classList.remove('active');
                        dom.input.value = '';
                    };
                    dom.suggestions.appendChild(div);
                });
                dom.suggestions.classList.add('active');
            }, 300);
        });

        function centerView() {
            state.x = (window.innerWidth/2) - 225; // center card
            state.y = (window.innerHeight/2) - 300;
            state.scale = 1;
            updateTransform();
        }

        function zoomIn() { state.scale *= 1.2; updateTransform(); }
        function zoomOut() { state.scale /= 1.2; updateTransform(); }
        function resetView() { centerView(); }

        // Init
        checkDevice();
        createNode("Internet");

    </script>
</body>
</html>

            
